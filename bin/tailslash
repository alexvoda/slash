#!/usr/bin/perl -w
use strict;
use Slash;
use Slash::DB;

my $virtual_user = @ARGV ? $ARGV[0] : 'slash';
my $slashdb = Slash::DB->new($virtual_user);

if ($ARGV[1] eq "today") {
	my($total, $today);
	my $pages = $slashdb->pagesServed();
	for (@$pages) {
		my($cnt, $h, $d) = @$_;
		$total = 0 unless $today == $d;
		$today = $d;
		$total += $cnt;
		print "| $h | $cnt  \t| $total  \t| " . sprintf("%.2f", $cnt/3600) . "\n";
	}
	print "$total pages served so far today.\n";

	exit;
}

my $id = $slashdb->maxAccessLog();
my $total;
my $starttime = time;

while (1) {
	sleep 3;
	my $info = $slashdb->getAccessLogInfo($id);

	my $sec = time - $starttime;
	$total += @$info;

	print "$sec\t| " . @$info . "\t| " . sprintf("%.2f", $total/$sec) . "\n"
		if $ARGV[1] eq "sec";
	for (@$info) {
		my($host_addr, $uid, $op, $dat, $ts, $id) = @$_;
		my $w="$ts $host_addr ($uid)";
		$w .= "\t" if length $w < 24;
		$w .= "\t$op";
		$w .= "\t" if length($op) < 8;
		$w .= "\t$dat\n";
		print $w unless $ARGV[1] eq "sec";
		$id = $id if $id > $id;
	}

}

